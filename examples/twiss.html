<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Example-01: Coupled twiss parameters &mdash; twiss  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/nbsphinx-code-cells.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Math" href="../modules/util.html" />
    <link rel="prev" title="Welcome to twiss’s documentation!" href="../index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            twiss
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Examples:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Example-01: Coupled twiss parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-02:-Tune-derivatives">Example-02: Tune derivatives</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-03:-Twiss-derivatives">Example-03: Twiss derivatives</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-04:-Phase-advance-derivatives">Example-04: Phase advance derivatives</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-05:-Tune-uncertainty-from-systematic-errors">Example-05: Tune uncertainty from systematic errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-06:-Matching-(composable)">Example-06: Matching (composable)</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-07:-Matching-(autograd)">Example-07: Matching (autograd)</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-08:-Matching-(autograd-&amp;-taylor-model)">Example-08: Matching (autograd &amp; taylor model)</a></li>
<li class="toctree-l1"><a class="reference internal" href="#Example-09:-Matched-distribution">Example-09: Matched distribution</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules/util.html">Math</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/util.html#twiss.util.mod"><code class="docutils literal notranslate"><span class="pre">mod()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/matrix.html">Matrix</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/matrix.html#twiss.matrix.is_symplectic"><code class="docutils literal notranslate"><span class="pre">is_symplectic()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/matrix.html#twiss.matrix.projection"><code class="docutils literal notranslate"><span class="pre">projection()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/matrix.html#twiss.matrix.rotation"><code class="docutils literal notranslate"><span class="pre">rotation()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/matrix.html#twiss.matrix.rotation_block"><code class="docutils literal notranslate"><span class="pre">rotation_block()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/matrix.html#twiss.matrix.symplectic_block"><code class="docutils literal notranslate"><span class="pre">symplectic_block()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/matrix.html#twiss.matrix.symplectic_identity"><code class="docutils literal notranslate"><span class="pre">symplectic_identity()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/matrix.html#twiss.matrix.symplectic_inverse"><code class="docutils literal notranslate"><span class="pre">symplectic_inverse()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/matrix.html#twiss.matrix.symplectify"><code class="docutils literal notranslate"><span class="pre">symplectify()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/wolski.html">Wolski</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/wolski.html#twiss.wolski.advance"><code class="docutils literal notranslate"><span class="pre">advance()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/wolski.html#twiss.wolski.is_stable"><code class="docutils literal notranslate"><span class="pre">is_stable()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/wolski.html#twiss.wolski.propagate"><code class="docutils literal notranslate"><span class="pre">propagate()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/wolski.html#twiss.wolski.twiss"><code class="docutils literal notranslate"><span class="pre">twiss()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/normal.html">Normal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/normal.html#twiss.normal.cs_normal"><code class="docutils literal notranslate"><span class="pre">cs_normal()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/normal.html#twiss.normal.lb_normal"><code class="docutils literal notranslate"><span class="pre">lb_normal()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/normal.html#twiss.normal.normal_to_wolski"><code class="docutils literal notranslate"><span class="pre">normal_to_wolski()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/normal.html#twiss.normal.parametric"><code class="docutils literal notranslate"><span class="pre">parametric()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/normal.html#twiss.normal.wolski_to_normal"><code class="docutils literal notranslate"><span class="pre">wolski_to_normal()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/convert.html">Convert</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/convert.html#twiss.convert.cs_to_wolski"><code class="docutils literal notranslate"><span class="pre">cs_to_wolski()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/convert.html#twiss.convert.lb_to_wolski"><code class="docutils literal notranslate"><span class="pre">lb_to_wolski()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/convert.html#twiss.convert.wolski_to_cs"><code class="docutils literal notranslate"><span class="pre">wolski_to_cs()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/convert.html#twiss.convert.wolski_to_lb"><code class="docutils literal notranslate"><span class="pre">wolski_to_lb()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/invariant.html">Invariant</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/invariant.html#twiss.invariant.cs_invariant"><code class="docutils literal notranslate"><span class="pre">cs_invariant()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/invariant.html#twiss.invariant.invariant"><code class="docutils literal notranslate"><span class="pre">invariant()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/invariant.html#twiss.invariant.lb_invariant"><code class="docutils literal notranslate"><span class="pre">lb_invariant()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/transport.html">Transport</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/transport.html#twiss.transport.cs_transport"><code class="docutils literal notranslate"><span class="pre">cs_transport()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/transport.html#twiss.transport.lb_transport"><code class="docutils literal notranslate"><span class="pre">lb_transport()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/transport.html#twiss.transport.momenta"><code class="docutils literal notranslate"><span class="pre">momenta()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/transport.html#twiss.transport.transport"><code class="docutils literal notranslate"><span class="pre">transport()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/transport.html#twiss.transport.wolski_transport"><code class="docutils literal notranslate"><span class="pre">wolski_transport()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/beam.html">Beam</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/beam.html#twiss.beam.distribution"><code class="docutils literal notranslate"><span class="pre">distribution()</span></code></a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">twiss</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Example-01: Coupled twiss parameters</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/examples/twiss.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Example-01:-Coupled-twiss-parameters">
<h1>Example-01: Coupled twiss parameters<a class="headerlink" href="#Example-01:-Coupled-twiss-parameters" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set elements</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">25</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="n">kn</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">kn</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="p">(</span><span class="n">kn</span><span class="o">*</span><span class="n">qx</span> <span class="o">-</span> <span class="n">ks</span><span class="o">*</span><span class="n">qy</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="p">(</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span> <span class="o">+</span> <span class="n">kn</span><span class="o">*</span><span class="n">qy</span><span class="p">)</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set transport maps</span>

<span class="k">def</span> <span class="nf">m11</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m12</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m23</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m34</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m45</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m56</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m67</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m78</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m89</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set fodo cell</span>

<span class="k">def</span> <span class="nf">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m11</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m12</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m23</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m34</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m45</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m56</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m67</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m78</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m89</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute one-turn transport matrix</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.20</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacrev</span><span class="p">(</span><span class="n">fodo</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">twiss.wolski</span> <span class="kn">import</span> <span class="n">is_stable</span>
<span class="nb">print</span><span class="p">(</span><span class="n">is_stable</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([[ 4.946e-01,  2.032e+01, -8.454e-03,  3.297e-01],
        [-3.725e-02,  4.946e-01,  4.386e-03,  8.052e-03],
        [ 8.052e-03,  3.297e-01, -9.236e-02,  3.539e+00],
        [ 4.386e-03, -8.454e-03, -2.806e-01, -9.236e-02]], dtype=torch.float64)
True
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute coupled twiss parameters</span>

<span class="kn">from</span> <span class="nn">twiss.wolski</span> <span class="kn">import</span> <span class="n">twiss</span>
<span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">twiss</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([1.677e-01, 2.647e-01], dtype=torch.float64)
tensor([[ 4.835e+00,  0.000e+00,  2.714e-02, -2.814e-16],
        [-6.488e-18,  2.069e-01,  3.388e-18, -7.283e-03],
        [ 6.634e-02, -5.239e-17,  1.884e+00,  0.000e+00],
        [-1.707e-18, -2.980e-03, -2.640e-16,  5.308e-01]], dtype=torch.float64)
tensor([[[ 2.338e+01, -3.137e-17,  3.208e-01, -8.252e-18],
         [-3.137e-17,  4.279e-02, -1.127e-17, -6.165e-04],
         [ 3.208e-01, -1.127e-17,  4.401e-03,  4.288e-20],
         [-8.252e-18, -6.165e-04,  4.288e-20,  8.880e-06]],

        [[ 7.367e-04,  2.142e-18,  5.114e-02, -1.566e-16],
         [ 2.142e-18,  5.305e-05,  6.384e-18, -3.866e-03],
         [ 5.114e-02,  6.384e-18,  3.550e+00, -4.974e-16],
         [-1.566e-16, -3.866e-03, -4.974e-16,  2.818e-01]]],
       dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check normalization matrix</span>

<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span>
<span class="kn">from</span> <span class="nn">twiss.matrix</span> <span class="kn">import</span> <span class="n">rotation</span>

<span class="nb">print</span><span class="p">(</span><span class="n">rotation</span><span class="p">(</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">t</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">inverse</span><span class="p">()</span> <span class="o">@</span> <span class="n">m</span> <span class="o">@</span> <span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([[4.945e-01, 8.692e-01, 0.000e+00, 0.000e+00],
        [-8.692e-01, 4.945e-01, 0.000e+00, 0.000e+00],
        [0.000e+00, 0.000e+00, -9.224e-02, 9.957e-01],
        [0.000e+00, 0.000e+00, -9.957e-01, -9.224e-02]], dtype=torch.float64)
tensor([[ 4.945e-01,  8.692e-01,  1.692e-18,  2.082e-17],
        [-8.692e-01,  4.945e-01,  3.384e-17,  3.816e-17],
        [ 6.772e-18,  4.424e-17, -9.224e-02,  9.957e-01],
        [ 7.236e-18,  3.578e-18, -9.957e-01, -9.224e-02]], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check twiss matrices</span>

<span class="kn">from</span> <span class="nn">twiss.matrix</span> <span class="kn">import</span> <span class="n">symplectic_identity</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">symplectic_identity</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ti</span><span class="p">,</span> <span class="n">wi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
    <span class="n">u</span> <span class="o">+=</span> <span class="p">(</span><span class="n">wi</span> <span class="o">@</span> <span class="n">s</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">ti</span><span class="p">)</span><span class="o">.</span><span class="n">sin</span><span class="p">()</span> <span class="o">-</span> <span class="p">(</span><span class="n">wi</span> <span class="o">@</span> <span class="n">s</span><span class="p">)</span> <span class="o">@</span> <span class="p">(</span><span class="n">wi</span> <span class="o">@</span> <span class="n">s</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">ti</span><span class="p">)</span><span class="o">.</span><span class="n">cos</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([[ 4.946e-01,  2.032e+01, -8.454e-03,  3.297e-01],
        [-3.725e-02,  4.946e-01,  4.386e-03,  8.052e-03],
        [ 8.052e-03,  3.297e-01, -9.236e-02,  3.539e+00],
        [ 4.386e-03, -8.454e-03, -2.806e-01, -9.236e-02]], dtype=torch.float64)
tensor([[ 4.946e-01,  2.032e+01, -8.454e-03,  3.297e-01],
        [-3.725e-02,  4.946e-01,  4.386e-03,  8.052e-03],
        [ 8.052e-03,  3.297e-01, -9.236e-02,  3.539e+00],
        [ 4.386e-03, -8.454e-03, -2.806e-01, -9.236e-02]], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute twiss at each location</span>

<span class="kn">from</span> <span class="nn">twiss.wolski</span> <span class="kn">import</span> <span class="n">propagate</span>

<span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="p">(</span><span class="n">m11</span><span class="p">,</span> <span class="n">m12</span><span class="p">,</span> <span class="n">m23</span><span class="p">,</span> <span class="n">m34</span><span class="p">,</span> <span class="n">m45</span><span class="p">,</span> <span class="n">m56</span><span class="p">,</span> <span class="n">m67</span><span class="p">,</span> <span class="n">m78</span><span class="p">,</span> <span class="n">m89</span><span class="p">):</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacrev</span><span class="p">(</span><span class="n">mapping</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
torch.Size([9, 2, 4, 4])
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Convert to CS and LB represencation</span>

<span class="kn">from</span> <span class="nn">twiss.convert</span> <span class="kn">import</span>  <span class="n">wolski_to_cs</span>
<span class="kn">from</span> <span class="nn">twiss.convert</span> <span class="kn">import</span>  <span class="n">wolski_to_lb</span>

<span class="n">ax</span><span class="p">,</span> <span class="n">bx</span><span class="p">,</span> <span class="n">ay</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">wolski_to_cs</span><span class="p">)(</span><span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="n">a1x</span><span class="p">,</span> <span class="n">b1x</span><span class="p">,</span> <span class="n">a2x</span><span class="p">,</span> <span class="n">b2x</span><span class="p">,</span> <span class="n">a1y</span><span class="p">,</span> <span class="n">b1y</span><span class="p">,</span> <span class="n">a2y</span><span class="p">,</span> <span class="n">b2y</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">wolski_to_lb</span><span class="p">)(</span><span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot in-plane twiss parameters</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="n">bx</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="n">b1x</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="n">by</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="n">b2y</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_twiss_11_0.png" src="../_images/examples_twiss_11_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot in-plane coupled twiss parameters</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="n">b2x</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="n">b1y</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_twiss_12_0.png" src="../_images/examples_twiss_12_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute phase advances</span>

<span class="kn">from</span> <span class="nn">twiss.wolski</span> <span class="kn">import</span> <span class="n">advance</span>

<span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="p">(</span><span class="n">m11</span><span class="p">,</span> <span class="n">m12</span><span class="p">,</span> <span class="n">m23</span><span class="p">,</span> <span class="n">m34</span><span class="p">,</span> <span class="n">m45</span><span class="p">,</span> <span class="n">m56</span><span class="p">,</span> <span class="n">m67</span><span class="p">,</span> <span class="n">m78</span><span class="p">,</span> <span class="n">m89</span><span class="p">):</span>
    <span class="n">mu</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">advance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacrev</span><span class="p">(</span><span class="n">mapping</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">out</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([1.677e-01, 2.647e-01], dtype=torch.float64)
tensor([1.677e-01, 2.647e-01], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot accumulated phase advance</span>

<span class="n">mux</span><span class="p">,</span> <span class="n">muy</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="n">mux</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="n">muy</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_twiss_14_0.png" src="../_images/examples_twiss_14_0.png" />
</div>
</div>
</section>
<section id="Example-02:-Tune-derivatives">
<h1>Example-02: Tune derivatives<a class="headerlink" href="#Example-02:-Tune-derivatives" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set elements</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">25</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="n">kn</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">kn</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="p">(</span><span class="n">kn</span><span class="o">*</span><span class="n">qx</span> <span class="o">-</span> <span class="n">ks</span><span class="o">*</span><span class="n">qy</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="p">(</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span> <span class="o">+</span> <span class="n">kn</span><span class="o">*</span><span class="n">qy</span><span class="p">)</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set transport maps</span>

<span class="k">def</span> <span class="nf">m11</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m12</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m23</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m34</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m45</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m56</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m67</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m78</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m89</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set fodo cell</span>

<span class="k">def</span> <span class="nf">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m11</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m12</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m23</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m34</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m45</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m56</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m67</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m78</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m89</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute tune derivatives</span>

<span class="kn">from</span> <span class="nn">twiss.wolski</span> <span class="kn">import</span> <span class="n">twiss</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacrev</span><span class="p">(</span><span class="n">fodo</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">twiss</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t</span>

<span class="n">d1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacrev</span><span class="p">(</span><span class="n">fn</span><span class="p">)(</span><span class="n">k</span><span class="p">)</span>
<span class="n">d2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacrev</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacrev</span><span class="p">(</span><span class="n">fn</span><span class="p">))(</span><span class="n">k</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([[1.832e+00, 0.000e+00, 5.027e-01, 0.000e+00],
        [-2.894e-01, 0.000e+00, -1.430e+00, 0.000e+00]], dtype=torch.float64)
tensor([[[-1.265e+01, 0.000e+00, -6.634e+00, 0.000e+00],
         [0.000e+00, -1.186e+01, 0.000e+00, -1.682e+01],
         [-6.634e+00, 0.000e+00, -1.069e+00, 0.000e+00],
         [0.000e+00, -1.682e+01, 0.000e+00, -1.547e+01]],

        [[-4.998e-02, 0.000e+00, -2.576e+00, 0.000e+00],
         [0.000e+00, 9.716e+00, 0.000e+00, 8.931e+00],
         [-2.576e+00, 0.000e+00, 7.011e-01, 0.000e+00],
         [0.000e+00, 8.931e+00, 0.000e+00, 1.286e+01]]], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Test</span>

<span class="n">dk</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.005</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.005</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.005</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">d1</span> <span class="o">@</span> <span class="n">dk</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">d1</span> <span class="o">@</span> <span class="n">dk</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="n">d2</span> <span class="o">@</span> <span class="n">dk</span> <span class="o">@</span> <span class="n">dk</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">twiss</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacrev</span><span class="p">(</span><span class="n">fodo</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="n">dk</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([1.674e-01, 2.645e-01], dtype=torch.float64)
tensor([1.740e-01, 2.702e-01], dtype=torch.float64)
tensor([1.741e-01, 2.703e-01], dtype=torch.float64)

tensor([1.741e-01, 2.703e-01], dtype=torch.float64)

</pre></div></div>
</div>
</section>
<section id="Example-03:-Twiss-derivatives">
<h1>Example-03: Twiss derivatives<a class="headerlink" href="#Example-03:-Twiss-derivatives" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set elements</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">25</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="n">kn</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">kn</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="p">(</span><span class="n">kn</span><span class="o">*</span><span class="n">qx</span> <span class="o">-</span> <span class="n">ks</span><span class="o">*</span><span class="n">qy</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="p">(</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span> <span class="o">+</span> <span class="n">kn</span><span class="o">*</span><span class="n">qy</span><span class="p">)</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set transport maps</span>

<span class="k">def</span> <span class="nf">m11</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m12</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m23</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m34</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m45</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m56</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m67</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m78</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m89</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set fodo cell</span>

<span class="k">def</span> <span class="nf">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m11</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m12</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m23</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m34</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m45</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m56</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m67</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m78</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m89</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set task function</span>

<span class="kn">from</span> <span class="nn">twiss.wolski</span> <span class="kn">import</span> <span class="n">twiss</span>
<span class="kn">from</span> <span class="nn">twiss.wolski</span> <span class="kn">import</span> <span class="n">propagate</span>
<span class="kn">from</span> <span class="nn">twiss.convert</span> <span class="kn">import</span> <span class="n">wolski_to_cs</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacrev</span><span class="p">(</span><span class="n">fodo</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">twiss</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="p">(</span><span class="n">m11</span><span class="p">,</span> <span class="n">m12</span><span class="p">,</span> <span class="n">m23</span><span class="p">,</span> <span class="n">m34</span><span class="p">,</span> <span class="n">m45</span><span class="p">,</span> <span class="n">m56</span><span class="p">,</span> <span class="n">m67</span><span class="p">,</span> <span class="n">m78</span><span class="p">,</span> <span class="n">m89</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacrev</span><span class="p">(</span><span class="n">mapping</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">,</span> <span class="n">bx</span><span class="p">,</span> <span class="n">ay</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">wolski_to_cs</span><span class="p">)(</span><span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute and plot twiss</span>

<span class="n">bx</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="n">bx</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="n">by</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_twiss_28_0.png" src="../_images/examples_twiss_28_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute twiss derivatives</span>

<span class="n">d1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacrev</span><span class="p">(</span><span class="n">fn</span><span class="p">)(</span><span class="n">k</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">d1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
torch.Size([9, 2, 4])
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Test</span>

<span class="n">dk</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.005</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.005</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.005</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="nb">print</span><span class="p">((</span><span class="n">fn</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">d1</span> <span class="o">@</span> <span class="n">dk</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="n">dk</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([[2.341e+01, 2.226e+01, 1.274e+01, 6.608e+00, 6.173e+00, 6.608e+00, 1.274e+01, 2.226e+01, 2.341e+01],
        [3.554e+00, 3.806e+00, 8.444e+00, 1.723e+01, 1.834e+01, 1.723e+01, 8.444e+00, 3.806e+00, 3.554e+00]],
       dtype=torch.float64)
tensor([[2.303e+01, 2.188e+01, 1.232e+01, 6.251e+00, 5.827e+00, 6.251e+00, 1.232e+01, 2.188e+01, 2.303e+01],
        [3.395e+00, 3.647e+00, 8.370e+00, 1.741e+01, 1.856e+01, 1.741e+01, 8.370e+00, 3.647e+00, 3.395e+00]],
       dtype=torch.float64)

tensor([[2.305e+01, 2.190e+01, 1.234e+01, 6.262e+00, 5.838e+00, 6.262e+00, 1.234e+01, 2.190e+01, 2.305e+01],
        [3.396e+00, 3.648e+00, 8.373e+00, 1.742e+01, 1.857e+01, 1.742e+01, 8.373e+00, 3.648e+00, 3.396e+00]],
       dtype=torch.float64)

</pre></div></div>
</div>
</section>
<section id="Example-04:-Phase-advance-derivatives">
<h1>Example-04: Phase advance derivatives<a class="headerlink" href="#Example-04:-Phase-advance-derivatives" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set elements</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">25</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="n">kn</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">kn</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="p">(</span><span class="n">kn</span><span class="o">*</span><span class="n">qx</span> <span class="o">-</span> <span class="n">ks</span><span class="o">*</span><span class="n">qy</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="p">(</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span> <span class="o">+</span> <span class="n">kn</span><span class="o">*</span><span class="n">qy</span><span class="p">)</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set transport maps</span>

<span class="k">def</span> <span class="nf">m11</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m12</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m23</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m34</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m45</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m56</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m67</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m78</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m89</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set fodo cell</span>

<span class="k">def</span> <span class="nf">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m11</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m12</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m23</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m34</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m45</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m56</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m67</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m78</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m89</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set task function</span>

<span class="kn">from</span> <span class="nn">twiss.wolski</span> <span class="kn">import</span> <span class="n">twiss</span>
<span class="kn">from</span> <span class="nn">twiss.wolski</span> <span class="kn">import</span> <span class="n">advance</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacrev</span><span class="p">(</span><span class="n">fodo</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">twiss</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="p">(</span><span class="n">m12</span><span class="p">,</span> <span class="n">m23</span><span class="p">,</span> <span class="n">m34</span><span class="p">,</span> <span class="n">m45</span><span class="p">,</span> <span class="n">m56</span><span class="p">,</span> <span class="n">m67</span><span class="p">,</span> <span class="n">m78</span><span class="p">,</span> <span class="n">m89</span><span class="p">):</span>
        <span class="n">mu</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">advance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacrev</span><span class="p">(</span><span class="n">mapping</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute and plot phase advance</span>

<span class="n">mux</span><span class="p">,</span> <span class="n">muy</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">mux</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">muy</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_twiss_37_0.png" src="../_images/examples_twiss_37_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute phase advance derivatives</span>

<span class="n">d1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacrev</span><span class="p">(</span><span class="n">fn</span><span class="p">)(</span><span class="n">k</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">d1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
torch.Size([8, 2, 4])
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Test</span>

<span class="n">dk</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.005</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.005</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.005</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="nb">print</span><span class="p">((</span><span class="n">fn</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">d1</span> <span class="o">@</span> <span class="n">dk</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="n">dk</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([[2.172e-02, 1.490e-01, 2.759e-01, 7.918e-02, 7.918e-02, 2.759e-01, 1.490e-01, 2.172e-02],
        [1.375e-01, 4.567e-01, 2.088e-01, 2.784e-02, 2.784e-02, 2.088e-01, 4.567e-01, 1.375e-01]],
       dtype=torch.float64)
tensor([[2.208e-02, 1.528e-01, 2.883e-01, 8.357e-02, 8.357e-02, 2.883e-01, 1.528e-01, 2.208e-02],
        [1.435e-01, 4.691e-01, 2.086e-01, 2.752e-02, 2.752e-02, 2.086e-01, 4.691e-01, 1.435e-01]],
       dtype=torch.float64)

tensor([[2.206e-02, 1.527e-01, 2.884e-01, 8.368e-02, 8.368e-02, 2.884e-01, 1.527e-01, 2.206e-02],
        [1.438e-01, 4.694e-01, 2.085e-01, 2.751e-02, 2.751e-02, 2.085e-01, 4.694e-01, 1.438e-01]],
       dtype=torch.float64)

</pre></div></div>
</div>
</section>
<section id="Example-05:-Tune-uncertainty-from-systematic-errors">
<h1>Example-05: Tune uncertainty from systematic errors<a class="headerlink" href="#Example-05:-Tune-uncertainty-from-systematic-errors" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set elements</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">25</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="n">kn</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">kn</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="p">(</span><span class="n">kn</span><span class="o">*</span><span class="n">qx</span> <span class="o">-</span> <span class="n">ks</span><span class="o">*</span><span class="n">qy</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="p">(</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span> <span class="o">+</span> <span class="n">kn</span><span class="o">*</span><span class="n">qy</span><span class="p">)</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set transport maps</span>

<span class="k">def</span> <span class="nf">m11</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m12</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m23</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m34</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m45</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m56</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m67</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m78</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m89</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set fodo cell</span>

<span class="k">def</span> <span class="nf">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m11</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m12</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m23</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m34</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m45</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m56</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m67</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m78</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m89</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute tune derivatives</span>

<span class="kn">from</span> <span class="nn">twiss.wolski</span> <span class="kn">import</span> <span class="n">twiss</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacrev</span><span class="p">(</span><span class="n">fodo</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">twiss</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t</span>

<span class="n">grad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacrev</span><span class="p">(</span><span class="n">fn</span><span class="p">)(</span><span class="n">k</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute tune uncertainty for given known knobs uncertanties</span>

<span class="n">sk</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="n">st</span> <span class="o">=</span> <span class="p">(</span><span class="n">grad</span><span class="o">**</span><span class="mi">2</span> <span class="o">@</span> <span class="n">sk</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>

<span class="n">st</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">fn</span><span class="p">)(</span><span class="n">k</span> <span class="o">+</span> <span class="n">sk</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">((</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([1.900e-02, 1.459e-02], dtype=torch.float64)
tensor([1.952e-02, 1.420e-02], dtype=torch.float64)
</pre></div></div>
</div>
</section>
<section id="Example-06:-Matching-(composable)">
<h1>Example-06: Matching (composable)<a class="headerlink" href="#Example-06:-Matching-(composable)" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set elements</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">25</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="n">kn</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">kn</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="p">(</span><span class="n">kn</span><span class="o">*</span><span class="n">qx</span> <span class="o">-</span> <span class="n">ks</span><span class="o">*</span><span class="n">qy</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="p">(</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span> <span class="o">+</span> <span class="n">kn</span><span class="o">*</span><span class="n">qy</span><span class="p">)</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set transport maps</span>

<span class="k">def</span> <span class="nf">m11</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">kn2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m12</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">kn2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m23</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">kn2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m34</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">kn2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m45</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">kn2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m56</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">kn2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m67</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">kn2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m78</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">kn2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m89</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">kn2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set fodo cell</span>

<span class="k">def</span> <span class="nf">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m11</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m12</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m23</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m34</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m45</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m56</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m67</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m78</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m89</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set objective function (bx &amp; by at focusing quadrupole center)</span>

<span class="kn">from</span> <span class="nn">twiss.wolski</span> <span class="kn">import</span> <span class="n">twiss</span>
<span class="kn">from</span> <span class="nn">twiss.convert</span> <span class="kn">import</span> <span class="n">wolski_to_cs</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="o">+</span><span class="mf">0.20</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.20</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="n">BX</span><span class="p">,</span> <span class="n">BY</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">25.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="n">bag</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">objective</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacrev</span><span class="p">(</span><span class="n">fodo</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">twiss</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">,</span> <span class="n">bx</span><span class="p">,</span> <span class="n">ay</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="n">wolski_to_cs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
        <span class="n">bag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">]))</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">bx</span> <span class="o">-</span> <span class="n">BX</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>  <span class="p">(</span><span class="n">by</span> <span class="o">-</span> <span class="n">BY</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set optimizer</span>

<span class="k">def</span> <span class="nf">adam</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">knobs</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">betas</span><span class="o">=</span><span class="p">(</span><span class="mf">0.900</span><span class="p">,</span> <span class="mf">0.999</span><span class="p">),</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1.0E-9</span><span class="p">):</span>
    <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">betas</span>
    <span class="n">history_knobs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">history_value</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">m1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">knobs</span><span class="p">)</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">knobs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacrev</span><span class="p">(</span><span class="n">objective</span><span class="p">)(</span><span class="n">knobs</span><span class="p">)</span>
        <span class="n">m1</span> <span class="o">=</span> <span class="n">b1</span> <span class="o">*</span> <span class="n">m1</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">b1</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad</span>
        <span class="n">m2</span> <span class="o">=</span> <span class="n">b2</span> <span class="o">*</span> <span class="n">m2</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">b2</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">b1</span> <span class="o">**</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">b2</span> <span class="o">**</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">knobs</span> <span class="o">=</span> <span class="n">knobs</span> <span class="o">-</span>  <span class="n">lr</span> <span class="o">*</span> <span class="n">m1</span> <span class="o">/</span> <span class="n">f1</span> <span class="o">/</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">m2</span> <span class="o">/</span> <span class="n">f2</span><span class="p">)</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">objective</span><span class="p">(</span><span class="n">knobs</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">history_knobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">knobs</span><span class="p">)</span>
        <span class="n">history_value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">,</span> <span class="p">[</span><span class="n">history_knobs</span><span class="p">,</span> <span class="n">history_value</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Optimize</span>

<span class="n">knobs</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">adam</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot beta values</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">bxs</span><span class="p">,</span> <span class="n">bys</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">bag</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="p">(</span><span class="n">bxs</span> <span class="o">-</span> <span class="n">BX</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="p">(</span><span class="n">bys</span> <span class="o">-</span> <span class="n">BY</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_twiss_55_0.png" src="../_images/examples_twiss_55_0.png" />
</div>
</div>
</section>
<section id="Example-07:-Matching-(autograd)">
<h1>Example-07: Matching (autograd)<a class="headerlink" href="#Example-07:-Matching-(autograd)" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set elements</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">25</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="n">kn</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">kn</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="p">(</span><span class="n">kn</span><span class="o">*</span><span class="n">qx</span> <span class="o">-</span> <span class="n">ks</span><span class="o">*</span><span class="n">qy</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="p">(</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span> <span class="o">+</span> <span class="n">kn</span><span class="o">*</span><span class="n">qy</span><span class="p">)</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set transport maps</span>

<span class="k">def</span> <span class="nf">m11</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">kn2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m12</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">kn2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m23</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">kn2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m34</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">kn2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m45</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">kn2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m56</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">kn2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m67</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">kn2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m78</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">kn2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m89</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">kn2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set fodo cell</span>

<span class="k">def</span> <span class="nf">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m11</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m12</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m23</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m34</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m45</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m56</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m67</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m78</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m89</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set objective function (bx &amp; by at focusing quadrupole center)</span>

<span class="kn">from</span> <span class="nn">twiss.wolski</span> <span class="kn">import</span> <span class="n">twiss</span>
<span class="kn">from</span> <span class="nn">twiss.convert</span> <span class="kn">import</span> <span class="n">wolski_to_cs</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="o">+</span><span class="mf">0.20</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.20</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="n">BX</span><span class="p">,</span> <span class="n">BY</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">25.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">objective</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacrev</span><span class="p">(</span><span class="n">fodo</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">twiss</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">,</span> <span class="n">bx</span><span class="p">,</span> <span class="n">ay</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="n">wolski_to_cs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">bx</span> <span class="o">-</span> <span class="n">BX</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>  <span class="p">(</span><span class="n">by</span> <span class="o">-</span> <span class="n">BY</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define model</span>

<span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objective</span><span class="p">,</span> <span class="n">knobs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objective</span> <span class="o">=</span> <span class="n">objective</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knobs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">knobs</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">knobs</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set optimizer</span>

<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Train</span>
<span class="c1"># Note, here forward method is a loss function</span>

<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">model</span><span class="p">()</span>
    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check result</span>

<span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="o">*</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()])</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacrev</span><span class="p">(</span><span class="n">fodo</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">twiss</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="n">ax</span><span class="p">,</span> <span class="n">bx</span><span class="p">,</span> <span class="n">ay</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="n">wolski_to_cs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([2.500e+01, 5.000e+00], dtype=torch.float64)
</pre></div></div>
</div>
</section>
<section id="Example-08:-Matching-(autograd-&amp;-taylor-model)">
<h1>Example-08: Matching (autograd &amp; taylor model)<a class="headerlink" href="#Example-08:-Matching-(autograd-&-taylor-model)" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set elements</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">25</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="n">kn</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">kn</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="p">(</span><span class="n">kn</span><span class="o">*</span><span class="n">qx</span> <span class="o">-</span> <span class="n">ks</span><span class="o">*</span><span class="n">qy</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="p">(</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span> <span class="o">+</span> <span class="n">kn</span><span class="o">*</span><span class="n">qy</span><span class="p">)</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set transport maps</span>

<span class="k">def</span> <span class="nf">m11</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">kn2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m12</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">kn2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m23</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">kn2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m34</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">kn2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m45</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">kn2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m56</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">kn2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m67</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">kn2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m78</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">kn2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m89</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">kn2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set fodo cell</span>

<span class="k">def</span> <span class="nf">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m11</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m12</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m23</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m34</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m45</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m56</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m67</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m78</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m89</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute parametric transport matrix</span>

<span class="kn">from</span> <span class="nn">ndtorch.derivative</span> <span class="kn">import</span> <span class="n">derivative</span>
<span class="kn">from</span> <span class="nn">ndtorch.evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="o">+</span><span class="mf">0.20</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.20</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacrev</span><span class="p">(</span><span class="n">fodo</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">k</span><span class="p">,</span> <span class="n">jacobian</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacfwd</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set objective function (bx &amp; by at focusing quadrupole center)</span>

<span class="kn">from</span> <span class="nn">twiss.wolski</span> <span class="kn">import</span> <span class="n">twiss</span>
<span class="kn">from</span> <span class="nn">twiss.convert</span> <span class="kn">import</span> <span class="n">wolski_to_cs</span>

<span class="n">dk</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="n">BX</span><span class="p">,</span> <span class="n">BY</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">25.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">objective</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span><span class="p">])</span>
    <span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">twiss</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">,</span> <span class="n">bx</span><span class="p">,</span> <span class="n">ay</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="n">wolski_to_cs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define model</span>

<span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objective</span><span class="p">,</span> <span class="n">knobs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objective</span> <span class="o">=</span> <span class="n">objective</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knobs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">knobs</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">knobs</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">dk</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set optimizer</span>

<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set loss function</span>

<span class="n">mse</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Train</span>

<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">model</span><span class="p">()</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">mse</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">BX</span><span class="p">,</span> <span class="n">BY</span><span class="p">]))</span>
    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot loss</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_twiss_77_0.png" src="../_images/examples_twiss_77_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check result</span>

<span class="n">dk</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="o">*</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()])</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacrev</span><span class="p">(</span><span class="n">fodo</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="n">dk</span><span class="p">)</span>
<span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">twiss</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="n">ax</span><span class="p">,</span> <span class="n">bx</span><span class="p">,</span> <span class="n">ay</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="n">wolski_to_cs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([2.500e+01, 5.000e+00], dtype=torch.float64)
</pre></div></div>
</div>
</section>
<section id="Example-09:-Matched-distribution">
<h1>Example-09: Matched distribution<a class="headerlink" href="#Example-09:-Matched-distribution" title="Link to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="n">torch</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sci_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set elements</span>

<span class="k">def</span> <span class="nf">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">l</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">25</span><span class="p">):</span>
    <span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">),</span> <span class="n">kn</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">kn</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">l</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span>
        <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">px</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="p">(</span><span class="n">kn</span><span class="o">*</span><span class="n">qx</span> <span class="o">-</span> <span class="n">ks</span><span class="o">*</span><span class="n">qy</span><span class="p">),</span> <span class="n">py</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="p">(</span><span class="n">ks</span><span class="o">*</span><span class="n">qx</span> <span class="o">+</span> <span class="n">kn</span><span class="o">*</span><span class="n">qy</span><span class="p">)</span>
        <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">qx</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">px</span><span class="p">,</span> <span class="n">qy</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">py</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">qx</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set transport maps</span>

<span class="k">def</span> <span class="nf">m11</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m12</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m23</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m34</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">drif</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
<span class="k">def</span> <span class="nf">m45</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="n">kn2</span><span class="p">,</span> <span class="n">ks2</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kn1</span><span class="p">,</span> <span class="n">ks1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span> <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set fodo cell</span>

<span class="k">def</span> <span class="nf">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m11</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m12</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m23</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m34</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m45</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute one-turn transport matrix</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.20</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">jacrev</span><span class="p">(</span><span class="n">fodo</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">twiss.wolski</span> <span class="kn">import</span> <span class="n">is_stable</span>
<span class="nb">print</span><span class="p">(</span><span class="n">is_stable</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([[ 2.443e+00,  1.933e+01,  6.129e-02,  3.072e-01],
        [-2.357e-01, -1.454e+00,  2.789e-03, -4.458e-02],
        [ 5.838e-02,  2.911e-01, -6.017e-01,  3.789e+00],
        [-3.216e-03, -7.752e-02, -3.310e-01,  4.167e-01]], dtype=torch.float64)
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute coupled twiss parameters</span>

<span class="kn">from</span> <span class="nn">twiss.wolski</span> <span class="kn">import</span> <span class="n">twiss</span>
<span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="n">ws</span> <span class="o">=</span> <span class="n">twiss</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate beam</span>

<span class="kn">from</span> <span class="nn">torch.distributions.multivariate_normal</span> <span class="kn">import</span> <span class="n">MultivariateNormal</span>

<span class="n">ex</span> <span class="o">=</span> <span class="mf">1.0E-6</span>
<span class="n">ey</span> <span class="o">=</span> <span class="mf">1.0E-8</span>

<span class="n">wx</span><span class="p">,</span> <span class="n">wy</span> <span class="o">=</span> <span class="n">ws</span>

<span class="n">mean</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">covariance_matrix</span> <span class="o">=</span> <span class="n">ex</span><span class="o">*</span><span class="n">wx</span> <span class="o">+</span> <span class="n">ey</span><span class="o">*</span><span class="n">wy</span>

<span class="n">distribution</span> <span class="o">=</span> <span class="n">MultivariateNormal</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">covariance_matrix</span><span class="p">)</span>

<span class="n">beam</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="mi">2</span><span class="o">**</span><span class="mi">14</span><span class="p">,</span> <span class="p">))</span><span class="o">.</span><span class="n">T</span>

<span class="nb">print</span><span class="p">(</span><span class="n">covariance_matrix</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">distribution</span><span class="o">.</span><span class="n">covariance_matrix</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">cov</span><span class="p">())</span>
<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([[ 2.224e-05, -2.241e-06,  2.924e-07, -8.274e-08],
        [-2.241e-06,  2.709e-07, -3.030e-08,  7.656e-09],
        [ 2.924e-07, -3.030e-08,  4.186e-08,  4.045e-09],
        [-8.274e-08,  7.656e-09,  4.045e-09,  3.639e-09]], dtype=torch.float64)

tensor([[ 2.224e-05, -2.241e-06,  2.924e-07, -8.274e-08],
        [-2.241e-06,  2.709e-07, -3.030e-08,  7.656e-09],
        [ 2.924e-07, -3.030e-08,  4.186e-08,  4.045e-09],
        [-8.274e-08,  7.656e-09,  4.045e-09,  3.639e-09]], dtype=torch.float64)

tensor([[ 2.258e-05, -2.270e-06,  3.068e-07, -8.127e-08],
        [-2.270e-06,  2.737e-07, -3.132e-08,  7.566e-09],
        [ 3.068e-07, -3.132e-08,  4.250e-08,  4.150e-09],
        [-8.127e-08,  7.566e-09,  4.150e-09,  3.737e-09]], dtype=torch.float64)

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Same with distribution function</span>

<span class="kn">from</span> <span class="nn">twiss.beam</span> <span class="kn">import</span> <span class="n">distribution</span>

<span class="n">bd</span> <span class="o">=</span> <span class="n">distribution</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">ex</span><span class="p">,</span> <span class="n">ey</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="n">ws</span><span class="p">)</span>

<span class="n">beam</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="mi">2</span><span class="o">**</span><span class="mi">14</span><span class="p">,</span> <span class="p">))</span><span class="o">.</span><span class="n">T</span>

<span class="nb">print</span><span class="p">(</span><span class="n">bd</span><span class="o">.</span><span class="n">covariance_matrix</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">cov</span><span class="p">())</span>
<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([[ 2.224e-05, -2.241e-06,  2.924e-07, -8.274e-08],
        [-2.241e-06,  2.709e-07, -3.030e-08,  7.656e-09],
        [ 2.924e-07, -3.030e-08,  4.186e-08,  4.045e-09],
        [-8.274e-08,  7.656e-09,  4.045e-09,  3.639e-09]], dtype=torch.float64)

tensor([[ 2.242e-05, -2.256e-06,  2.943e-07, -8.406e-08],
        [-2.256e-06,  2.712e-07, -3.072e-08,  7.747e-09],
        [ 2.943e-07, -3.072e-08,  4.132e-08,  3.877e-09],
        [-8.406e-08,  7.747e-09,  3.877e-09,  3.637e-09]], dtype=torch.float64)

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Transformed beam covariance matrix (matrix)</span>

<span class="nb">print</span><span class="p">((</span><span class="n">m</span> <span class="o">@</span> <span class="n">beam</span><span class="p">)</span><span class="o">.</span><span class="n">cov</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([[ 2.207e-05, -2.237e-06,  2.902e-07, -8.037e-08],
        [-2.237e-06,  2.718e-07, -3.016e-08,  7.510e-09],
        [ 2.902e-07, -3.016e-08,  4.220e-08,  4.181e-09],
        [-8.037e-08,  7.510e-09,  4.181e-09,  3.601e-09]], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Transformed beam covariance matrix (map)</span>

<span class="n">beam</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">fodo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">))(</span><span class="n">beam</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

<span class="nb">print</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">cov</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([[ 2.207e-05, -2.237e-06,  2.902e-07, -8.037e-08],
        [-2.237e-06,  2.718e-07, -3.016e-08,  7.510e-09],
        [ 2.902e-07, -3.016e-08,  4.220e-08,  4.181e-09],
        [-8.037e-08,  7.510e-09,  4.181e-09,  3.601e-09]], dtype=torch.float64)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Prepare data frame for plotting</span>

<span class="kn">import</span> <span class="nn">pandas</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;qx&#39;</span><span class="p">,</span> <span class="s1">&#39;px&#39;</span><span class="p">,</span> <span class="s1">&#39;qy&#39;</span><span class="p">,</span> <span class="s1">&#39;py&#39;</span><span class="p">]</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>qx</th>
      <th>px</th>
      <th>qy</th>
      <th>py</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.001170</td>
      <td>-0.000416</td>
      <td>0.000103</td>
      <td>0.000029</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-0.005233</td>
      <td>0.000350</td>
      <td>-0.000429</td>
      <td>-0.000102</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-0.002217</td>
      <td>0.000525</td>
      <td>0.000127</td>
      <td>0.000028</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-0.000162</td>
      <td>0.000225</td>
      <td>0.000340</td>
      <td>0.000031</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.003292</td>
      <td>-0.000302</td>
      <td>-0.000155</td>
      <td>-0.000074</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>16379</th>
      <td>-0.000195</td>
      <td>0.000328</td>
      <td>-0.000051</td>
      <td>-0.000052</td>
    </tr>
    <tr>
      <th>16380</th>
      <td>0.009093</td>
      <td>-0.001175</td>
      <td>0.000081</td>
      <td>-0.000031</td>
    </tr>
    <tr>
      <th>16381</th>
      <td>-0.004319</td>
      <td>0.000524</td>
      <td>-0.000298</td>
      <td>-0.000023</td>
    </tr>
    <tr>
      <th>16382</th>
      <td>0.000678</td>
      <td>-0.000255</td>
      <td>0.000462</td>
      <td>0.000018</td>
    </tr>
    <tr>
      <th>16383</th>
      <td>-0.001096</td>
      <td>0.000272</td>
      <td>0.000163</td>
      <td>-0.000049</td>
    </tr>
  </tbody>
</table>
<p>16384 rows × 4 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot beam</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s1">&#39;darkgrid&#39;</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">pairplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;kde&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_twiss_91_0.png" src="../_images/examples_twiss_91_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../index.html" class="btn btn-neutral float-left" title="Welcome to twiss’s documentation!" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../modules/util.html" class="btn btn-neutral float-right" title="Math" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Ivan Morozov.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>